pipeline {
    agent any

    options {
        buildDiscarder(logRotator(daysToKeepStr: '10', numToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "Repository checked out successfully"
            }
        }

        stage('Build & Test Hello') {
            steps {
                sh '''
                set -e

                echo "Python version:"
                python3 --version

                echo "Creating virtual environment"
                python3 -m venv .venv

                . .venv/bin/activate

                echo "Upgrading pip"
                pip install --upgrade pip

                # ---------------Install dependencies---------------
                if [ -f requirements.txt ]; then
                    echo "Installing dependencies from requirements.txt"
                    pip install -r requirements.txt
                else
                    echo "Error: requirements.txt not found!"
                    exit 1 # Stop the build if dependencies cannot be installed
                fi
                # ----------------------------------------------------

                echo "Running hello() demo"
                export PYTHONPATH="$(pwd)"
                python3 - <<'PY'
from agents.hello import hello
print(hello())
PY

                echo "Running pytest"
                pytest -q tests/test_hello.py
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline finished."
            sh 'rm -rf .venv || true'
        }
    }
}
