pipeline {
    agent {
        docker {
            image 'python:3.11-slim'
            args '--user root'
        }
    }

    options {
        buildDiscarder(logRotator(daysToKeepStr: '10', numToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "Repository checked out successfully"
            }
        }

        stage('Build & Test Hello') {
            steps {
                sh '''
                set -e

                python --version

                # install pytest
                pip install --no-cache-dir pytest

                # ensure repo root is importable
                export PYTHONPATH="$(pwd)"

                echo "Running hello() demo"
                python - <<'PY'
from agents.hello import hello
print(hello())
PY

                echo "Running pytest"
                pytest -q tests/test_hello.py
                '''
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
        }
    }
}
